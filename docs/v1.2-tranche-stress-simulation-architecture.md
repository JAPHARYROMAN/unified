# Unified v1.2 â€” Tranche Stress Simulation Architecture

## Purpose
Define a deterministic simulation architecture to evaluate tranche resilience before implementation.

## Scope
- Design only (no contract or orchestrator feature changes)
- Stress scenarios:
1. Mild default (5%)
2. Moderate default (10%)
3. Severe default (25%)
4. Correlated partner default
5. Liquidity shock + default overlap

## System Architecture
### 1) Scenario Orchestrator
- Loads scenario config and random seed
- Builds portfolio state for each run
- Applies shock events by timestep
- Invokes waterfall + breaker evaluation modules
- Emits manifest and summary metrics

### 2) Portfolio State Engine
- Tracks loans, partners, pools, and tranche balances over time
- Maintains NAV snapshots by timestep:
  - `juniorNAV`
  - `seniorNAV`
- Maintains liquidity state:
  - available liquidity
  - queued withdrawals
  - queue fulfillment lag

### 3) Shock Injection Engine
- Applies scenario-specific disturbances:
  - default ratios
  - correlation clusters
  - liquidity drawdowns
  - timing overlap
- Uses deterministic schedule + seed to ensure repeatability

### 4) Waterfall Engine
- Enforces loss allocation order:
  - junior absorbs first
  - senior absorbs residual only after junior exhaustion
- Produces allocation logs:
  - `lossAllocatedToJunior`
  - `lossAllocatedToSenior`
  - attachment/detachment breach timestamps

### 5) Breaker Evaluation Engine
- Evaluates threshold metrics per timestep:
  - partner default rate
  - delinquency rate
  - pool liquidity ratio
- Emits breaker events:
  - trigger type
  - scope (partner/pool/global)
  - actions (block/freeze/manual)

### 5.1) Breaker State Machine Simulation
- Simulated breaker states:
  - `NORMAL`
  - `PARTNER_BLOCKED`
  - `POOL_FROZEN`
  - `GLOBAL_HARD_STOP`
  - `RECOVERY_MONITOR`
  - `CLEARED`
- Transition inputs:
  - threshold breach events
  - persistence/stability windows
  - override and incident resolution actions
- Transition outputs:
  - origination policy (`allow`, `partner-block`, `freeze`, `global-stop`)
  - recovery gate requirements
  - auditable state transition log

### 6) Manifest & Audit Writer
- Produces run-level and loan/partner/tranche-level artifacts
- Stores deterministic audit output suitable for governance review

## Data Model (Simulation)
### Core Inputs
- `trancheConfig`: senior/junior sizes, attachment points
- `portfolioConfig`: number of loans, partner distribution, loan terms
- `riskConfig`: baseline PD/LGD, correlation matrix, liquidity stress multipliers
- `breakerConfig`: trigger thresholds and actions
- `seed`: deterministic run seed

### Core State
- `loanState[]`
- `partnerState[]`
- `poolState[]`
- `trancheState`:
  - `juniorNAV`
  - `seniorNAV`
  - cumulative losses by tranche

### Outputs
- timestep NAV series (junior/senior)
- waterfall allocation events
- breaker timeline
- reconciliation IDs / run IDs

## Scenario Blueprint
### Scenario 1: Mild Default (5%)
- Shock: 5% defaults distributed
- Expected:
  - Junior NAV declines
  - Senior NAV near-flat
  - Waterfall remains junior-only
  - Breaker likely warning-level only

### Scenario 2: Moderate Default (10%)
- Shock: 10% defaults with staggered timing
- Expected:
  - Junior NAV significant drawdown
  - Senior NAV limited impact unless junior exhausted
  - Breaker may activate partner-level controls

### Scenario 3: Severe Default (25%)
- Shock: 25% defaults in compressed window
- Expected:
  - Junior depletion likely
  - Senior impairment likely after junior depletion
  - Pool/global breaker actions expected

### Scenario 4: Correlated Partner Default
- Shock: concentrated defaults in top partner(s)
- Expected:
  - Concentration-driven junior drawdown
  - Partner-scoped breaker activation first
  - Healthy partners remain less affected

### Scenario 5: Liquidity Shock + Default Overlap
- Shock: simultaneous withdrawal pressure + defaults
- Expected:
  - Faster NAV deterioration in junior
  - Liquidity breaker + credit breaker co-firing
  - Waterfall ordering must remain intact

### Scenario 6: Concentration-Heavy Exposure
- Shock: top 1-2 partners carry majority exposure and underperform simultaneously
- Expected:
  - outsized tranche impact from concentrated names
  - earlier partner breaker transitions
  - stronger contamination into pool/global breaker states

## Dynamic Refinements
### Liquidity Spiral Feedback Loop
- Model iterative loop per timestep:
  - defaults/losses reduce confidence
  - withdrawals increase
  - liquidity ratio falls
  - forced realization haircuts increase losses
  - additional NAV drop drives further withdrawals
- Parameterize loop controls:
  - withdrawal sensitivity to NAV drawdown
  - slippage/haircut curve under stressed liquidity
  - breaker dampening effect on new risk origination

### Partial Recovery Modeling
- Add recovery legs for defaulted assets:
  - delayed recoveries by lag bucket (e.g., 30/60/90+ days)
  - stochastic or configured recovery rates by partner/risk tier
- Recovery allocation:
  - restore losses in reverse order of prior impairment accounting policy
  - maintain explicit trace of recovered-to-junior vs recovered-to-senior
- Recovery-to-breaker linkage:
  - move to `RECOVERY_MONITOR` when metrics normalize
  - clear only after stability window + no fresh breach

### Senior Withdrawal Acceleration Under Stress
- Model stress-conditioned senior behavior:
  - higher withdrawal request rates once trigger thresholds are crossed
  - priority/size effects on queue pressure
- Track acceleration metrics:
  - senior withdrawal velocity
  - senior queue share vs junior queue share
  - impact on liquidity ratio trajectory and breaker state persistence

## Evaluation Metrics
- `juniorNAVChangePct`, `seniorNAVChangePct`
- `juniorLossAbsorbed`, `seniorLossAbsorbed`
- `waterfallViolationCount` (must be 0)
- `waterfallSumResidual` (must be 0 within tolerance)
- `breakerTriggerCount` by trigger/scope
- `timeToBreakerActivation`
- `liquidityRatioMin`, `queueDepthMax`, `queueFulfillmentLag`
- `partnerConcentrationLossContribution`
- `seniorWithdrawalVelocity`
- `recoveryCoveragePct` and `timeToRecovery`

## Invariants
### Waterfall Sum Invariant
- For each timestep:
  - `totalPortfolioLoss = lossAllocatedToJunior + lossAllocatedToSenior + unresolvedResidual`
  - require `unresolvedResidual == 0` (or within strict numeric tolerance)
- For recovery steps:
  - `totalRecoveryApplied = recoveryToJunior + recoveryToSenior + recoveryResidual`
  - require `recoveryResidual == 0` (or within strict numeric tolerance)

## Acceptance Rules
- Deterministic replay with same seed produces identical outputs
- No senior loss before junior depletion
- Breakers trigger at configured thresholds
- Recovery scenarios clear incidents when conditions normalize

## Manifest Contract (Planned)
### Run-Level
- `runId`, `scenarioId`, `seed`, `generatedAt`
- `configHash`
- `summaryMetrics`

### Time-Series
- `timestep`, `juniorNAV`, `seniorNAV`, `liquidityRatio`
- `defaultsThisStep`, `cumulativeDefaults`

### Event Streams
- `waterfallEvents[]`
- `breakerEvents[]`
- `reconciliationReportIds[]`

### Audit Fields
- `deterministicChecksum`
- `invariantResults`
- `assertionResults`
